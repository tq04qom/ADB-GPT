# ADB-GPT 优化与可移植性路线（不改变现有功能）

> 目标：在保持现有行为不变的前提下，提升稳定性/效率，并为未来迁移到新 UI（Web 或新版桌面 UI）做好结构准备。

## 1. 现状速览（按代码结构）

- 入口与 UI：
  - `main.py`：当前主入口（Qt UI）。
  - `mumu_adb_controller/ui_qt/app_qt.py`：主窗口与调度中枢。
  - `mumu_adb_controller/ui_qt/device_tab_qt.py`：单设备页签，连接任务按钮与执行逻辑。
- 任务与识别：
  - `mumu_adb_controller/ui/tasks/*.py`：各自动化任务。
  - `mumu_adb_controller/ui/helpers/matcher.py`：模板匹配核心。
- 公共层：
  - `mumu_adb_controller/common/worker.py`：设备任务线程执行。
  - `mumu_adb_controller/common/pathutil.py`：资源路径解析。
  - `mumu_adb_controller/core/adb.py`：ADB 封装。

## 2. 当前主要优化机会

### 2.1 UI 与任务耦合偏高（影响未来迁移）

- 现状：`device_tab_qt.py` 直接依赖并调用 `ui/tasks/*.py`。
- 影响：未来替换 UI 时，任务调用链需要大量改动。
- 优化方向（不改功能）：
  1. 引入统一任务上下文（例如 `TaskContext`：adb、serial、log、toast、stop/pause）。
  2. 保持原任务逻辑不变，仅统一函数签名与调用入口。

### 2.2 任务中阻塞等待较多（影响响应性）

- 现状：多个任务大量使用 `time.sleep(...)`。
- 影响：暂停/停止响应慢，长任务期间交互体验下降。
- 优化方向（不改功能）：
  1. 抽象统一等待函数（支持 stop/pause 检查）。
  2. 先在高频任务试点，再逐步替换。

### 2.3 资源路径与参数分散（影响维护效率）

- 现状：任务内部存在资源路径、阈值、等待时长等分散配置。
- 影响：调参成本高、行为一致性难保证。
- 优化方向（不改功能）：
  1. 使用 `pathutil.py` 统一资源路径访问。
  2. 将阈值/等待参数集中到配置层（保留当前默认值）。

### 2.4 任务执行容错可再增强（影响稳定性）

- 现状：`worker.py` 已具备基本队列执行能力，但任务异常与超时治理可更系统化。
- 影响：单个任务异常可能影响后续执行可预期性。
- 优化方向（不改功能）：
  1. 增加任务级超时与标准化错误分类。
  2. 增强结构化日志（任务名、设备、阶段、耗时）。

## 3. 推荐的分阶段落地路线

### Phase A（低风险，优先）

1. 统一任务调用入口（Context 适配层，不动核心算法）。
2. 统一资源路径读取与默认参数配置。
3. 补充关键路径日志字段（耗时、重试次数、匹配阈值）。

### Phase B（中风险，中期）

1. 将“任务业务逻辑”与“UI 控件处理”拆分到独立逻辑层（可被 Qt/Web/CLI 复用）。
2. 为长任务统一引入 stop/pause 友好等待。
3. 为核心任务补充最小单元测试（以 matcher 与任务编排为主）。

### Phase C（迁移准备）

1. 通过“任务服务层”暴露稳定接口（保持当前 UI 调用不变）。
2. 新 UI 仅接入服务层，不直接耦合任务实现。
3. 完成新旧 UI 并行验证后再替换前端展示层。

## 4. 可量化评估指标（建议）

- 性能：
  - 单任务平均耗时（P50/P95）
  - 模板匹配平均耗时与重试次数
- 稳定性：
  - 任务成功率
  - 异常中断率、超时率
- 可维护性：
  - UI 层直接依赖任务模块数量（目标逐步下降）
  - 重复等待/路径代码行数（目标逐步下降）

## 5. 风险控制原则

1. **不改变功能行为**：默认参数、流程顺序、任务结果保持一致。
2. **先适配层，后重构**：优先做“包一层”的结构调整，避免一次性大改。
3. **每步可回滚**：每个阶段独立提交、独立验证。

---

如需执行层面的下一步，建议从 Phase A 的“任务 Context 适配层”开始：投入小、收益高、且对未来 UI 迁移帮助最大。
